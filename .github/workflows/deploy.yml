name: Deploy Plugin Updates

on:
  # Deploy on push to master
  push:
    branches: [master]
  
  # Allow manual deployment
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    # Add debugging information
    env:
      DEPLOYMENT_BRANCH: ${{ github.ref_name }}
      DEPLOYMENT_COMMIT: ${{ github.sha }}
    
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Debug Workflow Trigger
        run: |
          echo "🚀 Deployment workflow triggered!"
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "📤 Push to master triggered deployment"
            echo "✅ Proceeding with deployment..."
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "🔧 Manual deployment triggered"
            echo "✅ Proceeding with deployment..."
          fi

      - name: Check Required Secrets
        id: check-secrets
        run: |
          echo "🔍 Checking required secrets..."
          
          if [ -z "${{ secrets.SERVER_BASE_PATH }}" ]; then
            echo "❌ SERVER_BASE_PATH secret is missing!"
            echo "Please configure SERVER_BASE_PATH in GitHub Secrets"
            exit 1
          fi
          
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "❌ SERVER_HOST secret is missing!"
            echo "Please configure SERVER_HOST in GitHub Secrets"
            exit 1
          fi
          
          if [ -z "${{ secrets.SERVER_USERNAME }}" ]; then
            echo "❌ SERVER_USERNAME secret is missing!"
            echo "Please configure SERVER_USERNAME in GitHub Secrets"
            exit 1
          fi
          
          if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
            echo "❌ SERVER_SSH_KEY secret is missing!"
            echo "Please configure SERVER_SSH_KEY in GitHub Secrets"
            exit 1
          fi
          
          echo "✅ All plugin update secrets are configured"

      - name: Deploy All Plugins
        id: plugin-detection
        run: |
          echo "🚀 Deploying ALL plugins without git detection..."
          
          # Deploy all plugins found in the repository
          PLUGINS_TO_DEPLOY=""
          
          # Add all local plugins
          if [ -d "local" ]; then
            echo "📁 Scanning local plugins..."
            for dir in local/*/; do
              if [ -f "${dir}version.php" ]; then
                PLUGIN_DIR="${dir%/}"
                echo "✅ Found local plugin: $PLUGIN_DIR"
                PLUGINS_TO_DEPLOY="$PLUGINS_TO_DEPLOY $PLUGIN_DIR"
              fi
            done
          fi
          
          # Add all custom mod plugins
          if [ -d "mod" ]; then
            echo "📁 Scanning mod plugins..."
            for dir in mod/*/; do
              dirname=$(basename "$dir")
              # Skip built-in Moodle modules, focus on custom ones
              if [[ ! "$dirname" =~ ^(assign|book|chat|choice|data|feedback|forum|glossary|h5pactivity|imscp|label|lesson|lti|page|quiz|resource|scorm|survey|url|wiki|workshop)$ ]] && [ -f "${dir}version.php" ]; then
                PLUGIN_DIR="${dir%/}"
                echo "✅ Found mod plugin: $PLUGIN_DIR"
                PLUGINS_TO_DEPLOY="$PLUGINS_TO_DEPLOY $PLUGIN_DIR"
              fi
            done
          fi
          
          # Add all custom block plugins
          if [ -d "blocks" ]; then
            echo "📁 Scanning block plugins..."
            for dir in blocks/*/; do
              dirname=$(basename "$dir")
              # Skip built-in Moodle blocks, focus on custom ones
              if [[ ! "$dirname" =~ ^(accessreview|activity_modules|activity_results|admin_bookmarks|badges|blog_menu|blog_recent|blog_tags|calendar_month|calendar_upcoming|comments|completionstatus|course_list|course_summary|feedback|globalsearch|glossary_random|html|login|lp|mentees|mnet_hosts|myoverview|myprofile|navigation|news_items|online_users|private_files|recent_activity|recentlyaccessedcourses|recentlyaccesseditems|rss_client|search_forums|section_links|selfcompletion|settings|site_main_menu|social_activities|starredcourses|tag_flickr|tag_youtube|tags|timeline)$ ]] && [ -f "${dir}version.php" ]; then
                PLUGIN_DIR="${dir%/}"
                echo "✅ Found block plugin: $PLUGIN_DIR"
                PLUGINS_TO_DEPLOY="$PLUGINS_TO_DEPLOY $PLUGIN_DIR"
              fi
            done
          fi
          
          # Store plugins for deployment
          if [ -n "$PLUGINS_TO_DEPLOY" ]; then
            echo "📋 All plugins to deploy: $PLUGINS_TO_DEPLOY"
            echo "PLUGINS_TO_DEPLOY=$PLUGINS_TO_DEPLOY" >> $GITHUB_ENV
            echo "plugins_to_deploy=$PLUGINS_TO_DEPLOY" >> $GITHUB_OUTPUT
          else
            echo "⚠️ No plugins found in repository"
            echo "PLUGINS_TO_DEPLOY=" >> $GITHUB_ENV
            echo "plugins_to_deploy=" >> $GITHUB_OUTPUT
          fi

      - name: Plugin Update Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 300s
          command_timeout: 300s
          script: |
            # Get the list of plugins to deploy
            PLUGINS_TO_DEPLOY="${{ env.PLUGINS_TO_DEPLOY }}"
            
            echo "🔧 Starting MULTI-PLUGIN UPDATE deployment..."
            echo "📋 Plugins to deploy: $PLUGINS_TO_DEPLOY"
            
            # Navigate to Moodle directory
            echo "🔍 Attempting to navigate to: ${{ secrets.SERVER_BASE_PATH }}"
            cd ${{ secrets.SERVER_BASE_PATH }}
            echo "📍 Base directory: $(pwd)"
            
            # Check if moodle subdirectory exists
            if [ ! -d "moodle" ]; then
              echo "❌ Moodle directory not found in base path"
              echo "📁 Current directory contents:"
              ls -la
              echo "❌ Deployment failed: Moodle directory not found"
              exit 1
            fi
            
            # Navigate to the moodle subdirectory
            cd moodle
            echo "📍 Moodle directory: $(pwd)"
            
            # Check if this is a git repository
            if [ ! -d ".git" ]; then
              echo "❌ Not a git repository. Cannot pull latest changes."
              echo "📁 Current directory contents:"
              ls -la
              exit 1
            fi
            
            # Pull latest changes from git
            echo "📥 Pulling latest changes from git..."
            echo "🔍 Current branch: $(git branch --show-current)"
            echo "🔍 Available branches:"
            git branch -a
            
            # Configure git to use merge strategy for divergent branches
            git config pull.rebase false
            
            # Fetch all branches first
            echo "📥 Fetching all branches..."
            if ! git fetch --all; then
              echo "❌ Failed to fetch branches"
              exit 1
            fi
            
            # Pull from the correct branch (master or the deployment branch)
            DEPLOYMENT_BRANCH="${{ github.ref_name }}"
            echo "🔍 Deployment branch: $DEPLOYMENT_BRANCH"
            
            if [ "$DEPLOYMENT_BRANCH" = "refs/heads/master" ] || [ "$DEPLOYMENT_BRANCH" = "master" ]; then
              echo "📥 Pulling from master branch..."
              if ! git pull origin master; then
                echo "❌ Failed to pull from master branch"
                exit 1
              fi
            else
              echo "📥 Pulling from hotfix/new_updates branch..."
              if ! git pull origin hotfix/new_updates; then
                echo "❌ Failed to pull from hotfix/new_updates branch"
                exit 1
              fi
            fi
            
            # Show git status after pull
            echo "🔍 Git status after pull:"
            git status
            echo "🔍 Current branch after pull: $(git branch --show-current)"
            
            # If there are conflicts or issues, try a hard reset to the remote branch
            if [ "$(git status --porcelain)" != "" ]; then
              echo "⚠️ Git repository has uncommitted changes, performing hard reset..."
              if [ "$DEPLOYMENT_BRANCH" = "refs/heads/master" ] || [ "$DEPLOYMENT_BRANCH" = "master" ]; then
                git reset --hard origin/master
              else
                git reset --hard origin/hotfix/new_updates
              fi
              echo "✅ Hard reset completed"
            fi
            
            # Show what plugins are available after git pull
            echo "📁 Available plugins after git pull:"
            ls -la local/ 2>/dev/null || echo "No local plugins found"
            
            # Verify swap_list plugin specifically
            echo "🔍 Checking for swap_list plugin specifically:"
            if [ -d "local/swap_list" ]; then
              echo "✅ swap_list plugin found!"
              ls -la local/swap_list/
            else
              echo "❌ swap_list plugin not found!"
              echo "📁 Available local plugins:"
              ls -la local/ 2>/dev/null || echo "No local plugins found"
            fi
            
            # Deploy each plugin
            if [ -z "$PLUGINS_TO_DEPLOY" ]; then
              echo "⚠️ No plugins to deploy, checking if plugins exist..."
              echo "📁 Available directories:"
              ls -la
              echo "📁 Local directory contents:"
              ls -la local/ 2>/dev/null || echo "No local directory found"
              echo "⚠️ Skipping plugin deployment"
            else
              for plugin_path in $PLUGINS_TO_DEPLOY; do
              echo "🎯 Deploying plugin: $plugin_path"
              
              # Check if plugin exists after git pull
              if [ ! -d "$plugin_path" ]; then
                echo "❌ Plugin directory $plugin_path not found after git pull!"
                echo "📁 Available local plugins:"
                ls -la local/ 2>/dev/null || echo "No local plugins found"
                echo "⚠️ Continuing with other plugins..."
                continue
              fi
              
              # Create backup of existing plugin (if exists)
              echo "📋 Creating backup of existing plugin..."
              cp -r $plugin_path ${plugin_path}.backup.$(date +%Y%m%d_%H%M%S)
              echo "✅ Backup created successfully for $plugin_path"
              
              # Set proper permissions for plugin
              echo "🔐 Setting proper permissions for $plugin_path..."
              chmod -R 755 $plugin_path
              chown -R www-data:www-data $plugin_path
              echo "✅ Permissions set for $plugin_path"
              
              # Verify plugin installation
              echo "✅ Verifying plugin installation for $plugin_path..."
              if [ -f "$plugin_path/version.php" ]; then
                echo "✅ Plugin files are in place for $plugin_path"
                echo "📊 Plugin version info for $plugin_path:"
                grep -E "\$plugin->version|\$plugin->component" $plugin_path/version.php 2>/dev/null || echo "Could not read plugin version"
              else
                echo "❌ Plugin files not found at $plugin_path"
                echo "📁 Available files in plugin directory:"
                ls -la $plugin_path 2>/dev/null || echo "Plugin directory not accessible"
                echo "⚠️ Continuing with other plugins..."
                continue
              fi
              
              echo "✅ Successfully deployed plugin: $plugin_path"
            done
            fi
            
            # Clear Moodle cache after all plugins are deployed
            echo "🧹 Clearing Moodle cache..."
            if [ -f "admin/cli/purge_caches.php" ]; then
              if php admin/cli/purge_caches.php; then
                echo "✅ Cache cleared successfully"
              else
                echo "⚠️ Cache clearing failed, but continuing..."
              fi
            else
              echo "⚠️ Cache clearing script not found, but continuing..."
            fi
            
            # Check current plugin versions before upgrade
            echo "📊 Pre-upgrade version check..."
            echo "🧩 Current plugin versions:"
            find local/ -name "version.php" -exec echo "File: {}" \; -exec grep -E "\$plugin->version|\$plugin->component" {} \; 2>/dev/null || echo "No plugin version files found"
            
            # Run Moodle upgrade if needed
            echo "⬆️ Running Moodle upgrade..."
            if [ -f "admin/cli/upgrade.php" ]; then
              # Check and fix PHP max_input_vars setting if needed
              echo "🔍 Checking PHP settings..."
              CURRENT_MAX_INPUT_VARS=$(php -r "echo ini_get('max_input_vars');" 2>/dev/null || echo "0")
              echo "📊 Current max_input_vars: $CURRENT_MAX_INPUT_VARS"
              
              if [ "$CURRENT_MAX_INPUT_VARS" -lt 5000 ]; then
                echo "⚠️ max_input_vars is too low ($CURRENT_MAX_INPUT_VARS), attempting to set it for this session..."
                export PHP_INI_SCAN_DIR="/tmp"
                echo "max_input_vars = 10000" > /tmp/99-moodle.ini
              fi
              
              if php admin/cli/upgrade.php --non-interactive; then
                echo "✅ Moodle upgrade completed successfully"
                
                # Verify upgrade success
                echo "🔍 Post-upgrade verification..."
                if php admin/cli/cfg.php --component=core --name=version 2>/dev/null; then
                  echo "✅ Moodle core version updated successfully"
                else
                  echo "⚠️ Could not verify core version update"
                fi
                
              else
                echo "❌ Moodle upgrade failed!"
                echo "📋 Checking for upgrade issues..."
                
                # Check if it's a version conflict
                if [ -f "version.php" ]; then
                  echo "📊 Moodle version information:"
                  grep -E "\$release|\$version" version.php || echo "Could not read version info"
                fi
                
                # Check plugin versions
                echo "🧩 Plugin version information:"
                find local/ -name "version.php" -exec echo "File: {}" \; -exec grep -E "\$plugin->version|\$plugin->component" {} \; 2>/dev/null || echo "No plugin version files found"
                
                # Check for common upgrade issues
                echo "🔍 Common upgrade issue checks:"
                echo "- Database connection:"
                php -r "echo 'PHP version: ' . PHP_VERSION . PHP_EOL;" 2>/dev/null || echo "  PHP check failed"
                
                echo "⚠️ Moodle upgrade failed, but continuing with deployment..."
                echo "📋 This might be due to PHP settings or database issues"
                echo "🔧 You may need to manually run the upgrade later"
              fi
            else
              echo "⚠️ Upgrade script not found, skipping upgrade..."
            fi
            
            echo "🎉 Multi-plugin deployment completed successfully!"

      - name: Verify Plugin Updates
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 300s
          command_timeout: 300s
          script: |
            echo "🔍 Verifying multi-plugin deployment..."
            
            cd ${{ secrets.SERVER_BASE_PATH }}/moodle
            
            # Get the list of plugins that were deployed
            PLUGINS_TO_VERIFY="${{ steps.plugin-detection.outputs.plugins_to_deploy }}"
            
            echo "📋 Verifying plugins: $PLUGINS_TO_VERIFY"
            
            # Verify each plugin
            if [ -z "$PLUGINS_TO_VERIFY" ]; then
              echo "⚠️ No plugins to verify"
              echo "📁 Checking what plugins exist on server:"
              ls -la local/ 2>/dev/null || echo "No local plugins found on server"
            else
              for plugin_path in $PLUGINS_TO_VERIFY; do
              echo "🔍 Verifying plugin: $plugin_path"
              
              # Check plugin directory
              if [ -d "$plugin_path" ]; then
                echo "✅ Plugin directory exists: $plugin_path"
              else
                echo "❌ Plugin directory not found: $plugin_path"
                exit 1
              fi
              
              # Check plugin files
              if [ -f "$plugin_path/version.php" ]; then
                echo "✅ Plugin version file exists: $plugin_path"
              else
                echo "❌ Plugin version file not found: $plugin_path"
                exit 1
              fi
              
              # Check permissions
              if [ -r "$plugin_path/version.php" ]; then
                echo "✅ Plugin files are readable: $plugin_path"
              else
                echo "❌ Plugin files are not readable: $plugin_path"
                exit 1
              fi
            done
            fi
            
            echo "🎉 Multi-plugin verification completed successfully!"

      - name: Notify Plugin Update Success
        if: success()
        run: |
          echo "✅ Multi-plugin update deployed successfully!"
          echo "🌐 Server: ${{ secrets.SERVER_HOST }}"
          echo "🔗 Moodle URL: ${{ secrets.MOODLE_URL }}"
          echo "📅 Deployment completed at $(date)"
          echo "🎯 Plugins deployed: ${{ steps.plugin-detection.outputs.plugins_to_deploy }}"

      - name: Notify Deployment Failure
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          echo "🔍 Check the logs for more details."
          echo "📅 Failure occurred at $(date)"
          echo "🔄 You may need to manually deploy or check server configuration." 