# Learnfinity CI/CD System Documentation

## üéØ Overview

The Learnfinity project uses a sophisticated **CI/CD pipeline** that automatically tests Moodle plugins and deploys them to production servers. The system consists of two main workflows that work together to ensure code quality and reliable deployments.

## üìã Table of Contents

1. [Workflow Architecture](#workflow-architecture)
2. [Plugin Testing Workflow (learnfinity-ci.yml)](#plugin-testing-workflow)
3. [Deployment Workflow (deploy.yml)](#deployment-workflow)
4. [Configuration & Setup](#configuration--setup)
5. [Usage Guide](#usage-guide)
6. [Troubleshooting](#troubleshooting)
7. [Best Practices](#best-practices)

---

## üèóÔ∏è Workflow Architecture

```mermaid
graph TD
    A[Developer Pushes Code] --> B[Learnfinity Plugin CI]
    B --> C{All Tests Pass?}
    C -->|‚úÖ Yes| D[Deploy Workflow Triggered]
    C -->|‚ùå No| E[Deployment Blocked]
    D --> F[First-Time Deploy or Plugin Update]
    F --> G[Server Deployment]
    G --> H[Verification & Notification]
    
    I[Manual Trigger] --> D
    J[Emergency Deploy] --> D
```

### üîÑ Pipeline Flow

1. **Code Push** ‚Üí **Plugin Testing** ‚Üí **Deployment** ‚Üí **Verification**
2. **Parallel Execution**: Multiple PHP/Moodle versions tested simultaneously  
3. **Quality Gates**: Deployment only proceeds if all tests pass
4. **Fallback Options**: Manual and emergency deployment triggers available

---

## üß™ Plugin Testing Workflow (learnfinity-ci.yml)

### üéØ Purpose
Automatically detects and tests Moodle plugins for code quality, standards compliance, and functionality across multiple PHP and Moodle versions.

### ‚ö° Key Features

#### **üîç Dynamic Plugin Detection**
- **Auto-Discovery**: Automatically finds plugins in `local/`, `mod/`, and `blocks/` directories
- **Smart Filtering**: Ignores built-in Moodle plugins, focuses on custom developments
- **Manual Override**: Allows specifying exact plugin path via manual trigger

#### **üèóÔ∏è Multi-Matrix Testing**
```yaml
PHP Versions: 8.1, 8.2, 8.3
Moodle Versions: MOODLE_403_STABLE, MOODLE_404_STABLE, MOODLE_405_STABLE
Database: MySQL 8.4
```

#### **üìä Comprehensive Test Suite**
1. **PHP Lint** - Syntax validation
2. **PHP Mess Detector** - Code quality analysis  
3. **Moodle Code Checker** - Coding standards compliance
4. **PHPDoc Checker** - Documentation standards
5. **Plugin Validation** - Moodle-specific plugin validation
6. **Savepoints Check** - Database upgrade validation
7. **Grunt Tasks** - JavaScript/CSS validation
8. **PHPUnit Tests** - Unit test execution
9. **Behat Tests** - Functional test execution

### üöÄ Triggers

| Trigger Type | Condition | Use Case |
|--------------|-----------|----------|
| **Automatic** | Push to `master` branch | Normal development workflow |
| **Automatic** | Pull Request to `master` | Code review process |
| **Manual** | `workflow_dispatch` | On-demand testing |

### üîß Configuration

```yaml
# Manual trigger with custom plugin path
inputs:
  plugin_path:
    description: 'Plugin path to test (e.g., local/myplugin). Leave empty to auto-detect.'
    required: false
    type: string
```

---

## üöÄ Deployment Workflow (deploy.yml)

### üéØ Purpose
Deploys Moodle installations and plugin updates to production servers with automated verification and rollback capabilities.

### ‚ö° Key Features

#### **üîÄ Dual Deployment Modes**

##### **1. First-Time Moodle Deployment**
- **Complete Moodle Installation**: Clones entire Moodle codebase
- **Directory Structure Setup**: Creates `moodle/` and `moodledata/` directories
- **Permission Configuration**: Sets proper file/folder permissions
- **Configuration Setup**: Creates `config.php` from `config-dist.php`
- **Backup Integration**: Backs up existing installations

##### **2. Plugin Update Deployment** 
- **Incremental Updates**: Updates specific plugins only
- **Git Synchronization**: Pulls latest changes from repository
- **Database Upgrades**: Runs Moodle upgrade scripts
- **Cache Management**: Clears Moodle caches automatically
- **Plugin Verification**: Validates plugin installation

#### **üõ°Ô∏è Smart Trigger System**

| Trigger Type | Condition | Security Level |
|--------------|-----------|----------------|
| **Post-CI** | After successful CI tests | üîí **High** - Full testing |
| **Manual** | `workflow_dispatch` | üîß **Medium** - Admin control |
| **Emergency** | Deploy workflow changes | üö® **Low** - Bypass CI |

#### **‚úÖ Built-in Verification**
- **File Integrity**: Verifies all required files exist
- **Permission Validation**: Checks file/folder permissions
- **Database Connection**: Tests Moodle configuration
- **Plugin Status**: Validates plugin installation

### üîß Configuration Requirements

#### **First-Time Deployment Secrets**
```bash
FIRST_TIME_DEPLOYMENT=true          # Enables first-time mode
SERVER_HOST=your.server.com         # Server hostname/IP    
SERVER_USERNAME=your_ssh_user       # SSH username
SERVER_SSH_KEY=-----BEGIN RSA---    # SSH private key
SERVER_BASE_PATH=/var/www/html      # Installation directory
SERVER_PORT=22                      # SSH port (optional)
```

#### **Plugin Update Secrets**
```bash
FIRST_TIME_DEPLOYMENT=false         # Enables update mode  
SERVER_HOST=your.server.com         # Server hostname/IP
SERVER_USERNAME=your_ssh_user       # SSH username
SERVER_SSH_KEY=-----BEGIN RSA---    # SSH private key
MOODLE_PATH=/var/www/html/moodle    # Existing Moodle path
SERVER_PORT=22                      # SSH port (optional)
```

---

## ‚öôÔ∏è Configuration & Setup

### üîë 1. GitHub Secrets Setup

Navigate to: **Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions**

#### **Required for All Deployments:**
```bash
SERVER_HOST         # Your server IP or domain name
SERVER_USERNAME     # SSH username (e.g., 'azureuser')  
SERVER_SSH_KEY      # Private SSH key content
SERVER_PORT         # SSH port (default: 22)
```

#### **For First-Time Deployment:**
```bash
FIRST_TIME_DEPLOYMENT=true
SERVER_BASE_PATH=/var/www/html      # Where to install Moodle
```

#### **For Plugin Updates:**
```bash  
FIRST_TIME_DEPLOYMENT=false
MOODLE_PATH=/var/www/html/moodle    # Existing Moodle installation
```

### üñ•Ô∏è 2. Server Prerequisites

#### **Software Requirements:**
- **Operating System**: Ubuntu 20.04+ or CentOS 7+
- **Web Server**: Nginx or Apache
- **PHP**: 8.1, 8.2, or 8.3 with required extensions
- **Database**: MySQL 8.0+ or PostgreSQL 13+
- **Git**: Latest version

#### **PHP Extensions:**
```bash
sudo apt install php8.3-{mbstring,xml,intl,gd,curl,zip,mysqli,pgsql,soap,redis}
```

#### **Directory Permissions:**
```bash
# Ensure SSH user can write to web directory
sudo chown -R your_ssh_user:www-data /var/www/html
sudo chmod -R 775 /var/www/html
```

### üîê 3. SSH Key Setup

#### **Generate SSH Key (if needed):**
```bash
ssh-keygen -t rsa -b 4096 -C "github-deploy-key"
```

#### **Add Public Key to Server:**
```bash
# On your server
echo "your_public_key_content" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

#### **Add Private Key to GitHub:**
Copy the **entire private key** (including `-----BEGIN RSA PRIVATE KEY-----` and `-----END RSA PRIVATE KEY-----`) to the `SERVER_SSH_KEY` secret.

---

## üìñ Usage Guide

### üöÄ Normal Development Workflow

#### **1. Develop Your Plugin**
```bash
# Create plugin in local directory
mkdir local/myplugin
# ... develop your plugin files
```

#### **2. Commit & Push**
```bash
git add .
git commit -m "Add new plugin features"
git push origin master
```

#### **3. Automatic Process**
1. **CI Tests Run** ‚Üí Plugin automatically detected and tested
2. **Tests Pass** ‚Üí Deployment automatically triggered  
3. **Deployment Completes** ‚Üí Plugin available on server

### üîß Manual Operations

#### **Manual Testing Only**
```bash
# Go to Actions tab ‚Üí "Learnfinity Plugin CI" ‚Üí "Run workflow"
# Optionally specify plugin path: "local/myplugin"
```

#### **Manual Deployment**
```bash  
# Go to Actions tab ‚Üí "Deploy Moodle" ‚Üí "Run workflow"
```

#### **Emergency Deployment (Bypass CI)**
```bash
# Make any change to .github/workflows/deploy.yml
git add .github/workflows/deploy.yml
git commit -m "Emergency deployment trigger" 
git push origin master
```

### üìä Monitoring Workflows

#### **GitHub Actions Dashboard**
1. **Repository** ‚Üí **Actions tab**
2. **View running/completed workflows**
3. **Click workflow for detailed logs**
4. **Download artifacts** (test reports, screenshots)

#### **Workflow Status Badges**
Add to your README.md:
```markdown
![CI Status](https://github.com/username/repository/workflows/Learnfinity%20Plugin%20CI/badge.svg)
![Deploy Status](https://github.com/username/repository/workflows/Deploy%20Moodle/badge.svg)
```

---

## üîß Troubleshooting

### ‚ùå Common Issues & Solutions

#### **1. CI Tests Failing**

**Problem**: PHP Coding Standards violations
```bash
Solution:
- Run locally: vendor/bin/phpcs --standard=moodle /path/to/plugin
- Fix coding standards issues
- Commit and push fixes
```

**Problem**: PHPUnit tests failing
```bash
Solution:  
- Check test logic in tests/ directory
- Verify test data and assertions
- Run tests locally: vendor/bin/phpunit /path/to/plugin/tests
```

#### **2. Deployment Issues**

**Problem**: SSH connection failed
```bash
Solution:
- Verify SERVER_HOST, SERVER_USERNAME, SERVER_SSH_KEY secrets
- Test SSH connection manually: ssh user@host
- Check server SSH service: sudo systemctl status ssh
```

**Problem**: Permission denied during deployment
```bash
Solution:
- Fix server permissions: sudo chown -R user:www-data /var/www/html
- Set proper permissions: sudo chmod -R 775 /var/www/html
- Verify SSH user has sudo access (if needed)
```

**Problem**: Plugin not detected
```bash
Solution:
- Ensure plugin has version.php file
- Check plugin has lang/en/pluginname.php file
- Verify proper directory structure: local/pluginname/
```

#### **3. Moodle Installation Issues**

**Problem**: config.php database connection fails
```bash
Solution:
- Update config.php with correct database credentials
- Test database connection manually
- Check database server is running
```

**Problem**: Moodle upgrade fails
```bash
Solution:
- Check admin/cli/upgrade.php output
- Verify database permissions
- Check Moodle logs in moodledata/
```

### üìã Debug Checklist

```markdown
‚òê GitHub Secrets configured correctly
‚òê SSH key has proper format and permissions  
‚òê Server has required software installed
‚òê Directory permissions set correctly
‚òê Plugin follows Moodle standards
‚òê Database credentials are correct
‚òê Web server configuration is proper
```

---

## üèÜ Best Practices

### üìù Development Guidelines

#### **1. Plugin Structure**
```
local/myplugin/
‚îú‚îÄ‚îÄ version.php              # ‚úÖ Required - Plugin metadata
‚îú‚îÄ‚îÄ lib.php                  # ‚úÖ Required - Core functions
‚îú‚îÄ‚îÄ lang/en/local_myplugin.php # ‚úÖ Required - Language strings
‚îú‚îÄ‚îÄ settings.php             # üîß Optional - Admin settings
‚îú‚îÄ‚îÄ index.php                # üîß Optional - Main page
‚îú‚îÄ‚îÄ tests/                   # üß™ Recommended - Unit tests
‚îÇ   ‚îî‚îÄ‚îÄ myplugin_test.php    
‚îú‚îÄ‚îÄ classes/                 # üèóÔ∏è Recommended - OOP structure
‚îî‚îÄ‚îÄ README.md                # üìñ Recommended - Documentation
```

#### **2. Coding Standards**
```php
// ‚úÖ Always include Moodle header
<?php
// This file is part of Moodle - http://moodle.org/

// ‚úÖ Proper PHPDoc comments
/**
 * Description of function
 * 
 * @param string $param Description
 * @return bool Success status
 */
function my_function($param) {
    // ‚úÖ Follow Moodle coding standards
    global $DB, $USER;
    // Implementation
}
```

#### **3. Testing Strategy**
```php
// ‚úÖ Write comprehensive unit tests
class myplugin_test extends advanced_testcase {
    
    public function setUp(): void {
        $this->resetAfterTest(true);
    }
    
    public function test_my_function() {
        // Test implementation
        $this->assertTrue(my_function('test'));
    }
}
```

### üöÄ Deployment Guidelines

#### **1. Environment Separation**
```bash
# Development
FIRST_TIME_DEPLOYMENT=true
SERVER_BASE_PATH=/var/www/dev

# Production  
FIRST_TIME_DEPLOYMENT=false
MOODLE_PATH=/var/www/html/moodle
```

#### **2. Rollback Strategy**
- **Automated Backups**: Every deployment creates timestamped backups
- **Manual Rollback**: SSH to server and restore from backup
- **Database Backups**: Regular automated database backups
- **Version Control**: Use Git tags for release management

#### **3. Monitoring & Alerts**
```yaml
# Set up GitHub notifications
- Email notifications for workflow failures
- Slack/Teams integration for deployment status
- Server monitoring for performance metrics
```

### üîí Security Best Practices

#### **1. SSH Security**
```bash
# Use dedicated deploy key (not personal SSH key)
ssh-keygen -t rsa -b 4096 -C "deploy-key-learnfinity" -f deploy_key

# Restrict SSH key permissions on server
echo 'command="cd /var/www && $SSH_ORIGINAL_COMMAND" ssh-rsa AAAAB...' >> ~/.ssh/authorized_keys
```

#### **2. Server Security**
```bash
# Disable password authentication
sudo sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

# Use fail2ban for brute force protection
sudo apt install fail2ban

# Regular security updates
sudo apt update && sudo apt upgrade
```

#### **3. Moodle Security**
```php
// config.php security settings
$CFG->forcessl = true;                    // Force HTTPS
$CFG->cookiesecure = true;                // Secure cookies
$CFG->preventexecpath = true;             // Prevent execution
$CFG->disableupdateautodeploy = true;     // Disable auto-updates
```

---

## üìû Support & Contributing

### üÜò Getting Help
- **GitHub Issues**: Report bugs and request features
- **Documentation**: Check this guide and inline comments
- **Community**: Moodle Developer Forums

### ü§ù Contributing
1. **Fork the repository**
2. **Create feature branch**: `git checkout -b feature/amazing-feature`
3. **Follow coding standards**: Use the CI tests to validate
4. **Write tests**: Add appropriate test coverage
5. **Submit Pull Request**: CI will automatically test your changes

### üìö Additional Resources
- **Moodle Developer Documentation**: https://docs.moodle.org/dev/
- **PHP Standards**: https://www.php-fig.org/psr/
- **GitHub Actions**: https://docs.github.com/en/actions

---

## üè∑Ô∏è Version Information

- **Documentation Version**: 1.0
- **Compatible with**: Moodle 4.0+ 
- **Last Updated**: January 2025
- **Maintained by**: Learnfinity Development Team

---

*This documentation is automatically updated with each release. For the latest version, check the repository's docs/ directory.* 