{"version":3,"file":"training_sync_rules.min.js","sources":["../src/training_sync_rules.js"],"sourcesContent":["/* eslint-disable no-console */\r\n/* eslint-disable promise/catch-or-return */\r\n/* eslint-disable promise/always-return */\r\nconsole.log('Training sync rules AMD module loaded');\r\ndefine([\r\n    'jquery',\r\n    'core/str',\r\n    'core/ajax',\r\n    'core/notification',\r\n    'core/templates',\r\n    'core/url'\r\n], function(\r\n    $,\r\n    str,\r\n    ajax,\r\n    notification,\r\n) {\r\n    \"use strict\";\r\n    var trainingSyncRules = {\r\n        dom: {\r\n            main: null,\r\n            frameworksSelect: null,\r\n            coursesSelect: null,\r\n            completionModeContainer: null,\r\n            completionModeSelect: null,\r\n            saveButton: null,\r\n            form: null,\r\n            resourceId: null\r\n        },\r\n        lang: {\r\n            somethingWentWrong: null,\r\n            saveSuccess: null\r\n        },\r\n        variables: {\r\n            vantaId: 0,\r\n            selectedFrameworks: [],\r\n            selectedCourses: []\r\n        },\r\n        action: {\r\n            getStringValues: function() {\r\n                return str.get_strings([\r\n                    {\r\n                        key: \"some_thing_went_wrong\",\r\n                        component: \"local_vanta\"\r\n                    },\r\n                    {\r\n                        key: \"settingssaved\",\r\n                        component: \"local_vanta\"\r\n                    }\r\n                ]).then(function(langstrs) {\r\n                    trainingSyncRules.lang.somethingWentWrong = langstrs[0];\r\n                    trainingSyncRules.lang.saveSuccess = langstrs[1];\r\n                    return true;\r\n                }).catch(function(error) {\r\n                    console.error('Failed to load language strings:', error);\r\n                    notification.addNotification({\r\n                        type: \"error\",\r\n                        message: \"Failed to load language strings\"\r\n                    });\r\n                    return false;\r\n                });\r\n            },\r\n            validation: function() {\r\n                console.log('Running validation...');\r\n                var isValid = true;\r\n\r\n                // Validate resource ID\r\n                if (!trainingSyncRules.dom.resourceId || trainingSyncRules.dom.resourceId.val() === '') {\r\n                    console.log('Resource ID validation failed');\r\n                    if (trainingSyncRules.dom.resourceId) {\r\n                        trainingSyncRules.dom.resourceId.addClass('is-invalid');\r\n                    }\r\n                    isValid = false;\r\n                } else {\r\n                    if (trainingSyncRules.dom.resourceId) {\r\n                        trainingSyncRules.dom.resourceId.removeClass('is-invalid');\r\n                    }\r\n                }\r\n\r\n                // Validate frameworks\r\n                if (trainingSyncRules.variables.selectedFrameworks.length === 0) {\r\n                    console.log('Frameworks validation failed');\r\n                    if (trainingSyncRules.dom.frameworksSelect) {\r\n                        trainingSyncRules.dom.frameworksSelect.addClass('is-invalid');\r\n                    }\r\n                    isValid = false;\r\n                } else {\r\n                    if (trainingSyncRules.dom.frameworksSelect) {\r\n                        trainingSyncRules.dom.frameworksSelect.removeClass('is-invalid');\r\n                    }\r\n                }\r\n\r\n                // Validate courses\r\n                if (trainingSyncRules.variables.selectedCourses.length === 0) {\r\n                    console.log('Courses validation failed');\r\n                    if (trainingSyncRules.dom.coursesSelect) {\r\n                        trainingSyncRules.dom.coursesSelect.addClass('is-invalid');\r\n                    }\r\n                    isValid = false;\r\n                } else {\r\n                    if (trainingSyncRules.dom.coursesSelect) {\r\n                        trainingSyncRules.dom.coursesSelect.removeClass('is-invalid');\r\n                    }\r\n                }\r\n\r\n                console.log('Validation result:', isValid);\r\n                return isValid;\r\n            },\r\n\r\n            saveSettings: function() {\r\n                console.log('Starting save settings...');\r\n\r\n                var formData = {\r\n                    frameworks: trainingSyncRules.variables.selectedFrameworks,\r\n                    courses: trainingSyncRules.variables.selectedCourses,\r\n                    completionmode: trainingSyncRules.dom.completionModeSelect.val(),\r\n                    resourceid: trainingSyncRules.dom.resourceId.val(),\r\n                };\r\n\r\n                console.log('Form data:', formData);\r\n\r\n                // Use standard Moodle AJAX call to save settings\r\n                return ajax.call([{\r\n                    methodname: 'local_vanta_save_sync_rules',\r\n                    args: formData\r\n                }])[0].then(function(response) {\r\n                    console.log('Save response:', response);\r\n\r\n                    if (response.success) {\r\n                        notification.addNotification({\r\n                            type: 'success',\r\n                            message: trainingSyncRules.lang.saveSuccess\r\n                        });\r\n                    } else {\r\n                        notification.addNotification({\r\n                            type: 'error',\r\n                            message: response.message || trainingSyncRules.lang.somethingWentWrong\r\n                        });\r\n                    }\r\n                    return response;\r\n                }).catch(function(error) {\r\n                    console.error('Save failed:', error);\r\n                    notification.addNotification({\r\n                        type: 'error',\r\n                        message: trainingSyncRules.lang.somethingWentWrong\r\n                    });\r\n                    throw error;\r\n                });\r\n            },\r\n\r\n            initializeSelects: function() {\r\n                // Initialize select2 with error handling\r\n                if (trainingSyncRules.dom.frameworksSelect.length > 0) {\r\n                    try {\r\n                        trainingSyncRules.dom.frameworksSelect.select2({\r\n                            placeholder: \"Select compliance frameworks\",\r\n                            allowClear: true,\r\n                            width: '100%'\r\n                        });\r\n                    } catch (e) {\r\n                        console.error('Error initializing frameworks select2:', e);\r\n                    }\r\n                }\r\n\r\n                if (trainingSyncRules.dom.coursesSelect.length > 0) {\r\n                    try {\r\n                        trainingSyncRules.dom.coursesSelect.select2({\r\n                            placeholder: \"Select courses\",\r\n                            allowClear: true,\r\n                            width: '100%'\r\n                        });\r\n                    } catch (e) {\r\n                        console.error('Error initializing courses select2:', e);\r\n                    }\r\n                }\r\n            }\r\n        },\r\n\r\n        init: function(config) {\r\n            console.log('Initializing training sync rules with config:', config);\r\n\r\n            // Store vantaId from config\r\n            if (config && config.vantaId) {\r\n                trainingSyncRules.variables.vantaId = config.vantaId;\r\n            }\r\n\r\n            // Initialize DOM references\r\n            trainingSyncRules.dom.main = $('#local_vanta_training_sync_rules');\r\n            trainingSyncRules.dom.form = $('#vanta-sync-rules-form');\r\n            trainingSyncRules.dom.frameworksSelect = $('#frameworks');\r\n            trainingSyncRules.dom.coursesSelect = $('#courses');\r\n            trainingSyncRules.dom.resourceId = $('.resource_id');\r\n            trainingSyncRules.dom.completionModeContainer = $('#completion_mode_container');\r\n            trainingSyncRules.dom.completionModeSelect = $('#completion_mode');\r\n            trainingSyncRules.dom.saveButton = $('.save-sync-rules');\r\n\r\n            // Load language strings first\r\n            return trainingSyncRules.action.getStringValues().then(function() {\r\n                // Initialize select2 dropdowns\r\n                trainingSyncRules.action.initializeSelects();\r\n\r\n                // Store initial values\r\n                trainingSyncRules.variables.selectedFrameworks = trainingSyncRules.dom.frameworksSelect.val() || [];\r\n                trainingSyncRules.variables.selectedCourses = trainingSyncRules.dom.coursesSelect.val() || [];\r\n\r\n                // Handle save button click\r\n                trainingSyncRules.dom.saveButton.on('click', function(e) {\r\n                    console.log('Save button clicked');\r\n                    e.preventDefault();\r\n                    e.stopPropagation();\r\n\r\n                    // Update variables before validation\r\n                    trainingSyncRules.variables.selectedFrameworks = trainingSyncRules.dom.frameworksSelect.val() || [];\r\n                    trainingSyncRules.variables.selectedCourses = trainingSyncRules.dom.coursesSelect.val() || [];\r\n\r\n                    if (trainingSyncRules.action.validation()) {\r\n                        trainingSyncRules.action.saveSettings();\r\n                    }\r\n                });\r\n\r\n                // Handle select changes\r\n                trainingSyncRules.dom.frameworksSelect.on('change', function() {\r\n                    trainingSyncRules.variables.selectedFrameworks = $(this).val() || [];\r\n                });\r\n\r\n                trainingSyncRules.dom.coursesSelect.on('change', function() {\r\n                    trainingSyncRules.variables.selectedCourses = $(this).val() || [];\r\n                });\r\n\r\n                return true;\r\n            });\r\n        }\r\n    };\r\n\r\n    return {\r\n        init: trainingSyncRules.action.getStringValues\r\n    };\r\n});"],"names":["console","log","define","$","str","ajax","notification","trainingSyncRules","dom","main","frameworksSelect","coursesSelect","completionModeContainer","completionModeSelect","saveButton","form","resourceId","lang","somethingWentWrong","saveSuccess","variables","vantaId","selectedFrameworks","selectedCourses","action","getStringValues","get_strings","key","component","then","langstrs","catch","error","addNotification","type","message","validation","isValid","val","removeClass","addClass","length","saveSettings","formData","frameworks","courses","completionmode","resourceid","call","methodname","args","response","success","initializeSelects","select2","placeholder","allowClear","width","e","init","config","on","preventDefault","stopPropagation","this"],"mappings":"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"}