name: Deploy Moodle (First Time) / Plugin Updates

on:
  # Deploy after CI tests pass
  workflow_run:
    workflows: ["Learnfinity Plugin CI"]
    types:
      - completed
    branches: [master]
  
  # Allow manual deployment
  workflow_dispatch:
  
  # Emergency direct deployment (bypass CI)
  push:
    branches: [master]
    paths: ['.github/workflows/deploy.yml']

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only run if CI tests passed (or manual/emergency trigger)
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, '.github/workflows/deploy.yml')) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    
    # Add debugging information
    env:
      DEPLOYMENT_BRANCH: ${{ github.ref_name }}
      DEPLOYMENT_COMMIT: ${{ github.sha }}
    
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Debug Workflow Trigger
        run: |
          echo "ğŸš€ Deployment workflow triggered!"
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "ğŸ§ª Triggered by CI workflow: ${{ github.event.workflow_run.name }}"
            echo "ğŸ¯ CI workflow status: ${{ github.event.workflow_run.conclusion }}"
            echo "âœ… CI tests passed - proceeding with deployment!"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ğŸ”§ Manual deployment triggered"
          else
            echo "ğŸš¨ Emergency deployment triggered"
          fi
          
          echo "âœ… Proceeding with deployment..."

      - name: Check Required Secrets
        id: check-secrets
        run: |
          echo "ğŸ” Checking required secrets..."
          
          # Check first-time deployment secrets
          if [ "${{ secrets.FIRST_TIME_DEPLOYMENT }}" = "true" ]; then
            echo "deployment_type=first_time" >> $GITHUB_OUTPUT
            echo "ğŸš€ First-time Moodle deployment detected"
            
            if [ -z "${{ secrets.SERVER_BASE_PATH }}" ]; then
              echo "âŒ SERVER_BASE_PATH secret is missing!"
              echo "Please configure SERVER_BASE_PATH in GitHub Secrets"
              exit 1
            fi
            
            if [ -z "${{ secrets.SERVER_HOST }}" ]; then
              echo "âŒ SERVER_HOST secret is missing!"
              echo "Please configure SERVER_HOST in GitHub Secrets"
              exit 1
            fi
            
            if [ -z "${{ secrets.SERVER_USERNAME }}" ]; then
              echo "âŒ SERVER_USERNAME secret is missing!"
              echo "Please configure SERVER_USERNAME in GitHub Secrets"
              exit 1
            fi
            
            if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
              echo "âŒ SERVER_SSH_KEY secret is missing!"
              echo "Please configure SERVER_SSH_KEY in GitHub Secrets"
              exit 1
            fi
            
            echo "âœ… All first-time deployment secrets are configured"
          else
            echo "deployment_type=plugin_update" >> $GITHUB_OUTPUT
            echo "ğŸ”§ Plugin update deployment detected"
            
            if [ -z "${{ secrets.MOODLE_PATH }}" ]; then
              echo "âŒ MOODLE_PATH secret is missing!"
              echo "Please configure MOODLE_PATH in GitHub Secrets"
              exit 1
            fi
            
            if [ -z "${{ secrets.SERVER_HOST }}" ]; then
              echo "âŒ SERVER_HOST secret is missing!"
              echo "Please configure SERVER_HOST in GitHub Secrets"
              exit 1
            fi
            
            if [ -z "${{ secrets.SERVER_USERNAME }}" ]; then
              echo "âŒ SERVER_USERNAME secret is missing!"
              echo "Please configure SERVER_USERNAME in GitHub Secrets"
              exit 1
            fi
            
            if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
              echo "âŒ SERVER_SSH_KEY secret is missing!"
              echo "Please configure SERVER_SSH_KEY in GitHub Secrets"
              exit 1
            fi
            
            echo "âœ… All plugin update secrets are configured"
          fi

      - name: First-time Moodle Deployment
        if: steps.check-secrets.outputs.deployment_type == 'first_time'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸš€ Starting FIRST-TIME Moodle deployment..."
            
            # Check if base path exists, create if not
            if [ ! -d "${{ secrets.SERVER_BASE_PATH }}" ]; then
              echo "ğŸ“ Creating base directory..."
              mkdir -p ${{ secrets.SERVER_BASE_PATH }}
            fi
            
            # Navigate to server directory
            cd ${{ secrets.SERVER_BASE_PATH }}
            echo "ğŸ“ Current directory: $(pwd)"
            
            # Create backup of existing Moodle (if exists)
            if [ -d "moodle" ]; then
              echo "ğŸ“‹ Creating backup of existing Moodle installation..."
              cp -r moodle moodle.backup.$(date +%Y%m%d_%H%M%S)
              echo "âœ… Backup created successfully"
            fi
            
            # Remove existing moodle directory if it exists
            if [ -d "moodle" ]; then
              echo "ğŸ—‘ï¸ Removing existing moodle directory..."
              rm -rf moodle
            fi
            
            # Clone the complete Moodle repository
            echo "ğŸ“¥ Cloning complete Moodle codebase..."
            git clone -b master https://github.com/${{ github.repository }}.git moodle
            cd moodle
            
            # Check if this is a valid Moodle installation
            if [ ! -f "version.php" ]; then
              echo "âŒ This doesn't appear to be a valid Moodle installation"
              echo "ğŸ“ Current directory contents:"
              ls -la
              exit 1
            fi
            
            # Set proper permissions for entire Moodle installation
            echo "ğŸ” Setting proper permissions..."
            find . -type f -exec chmod 644 {} \; 2>/dev/null || echo "âš ï¸ Some files couldn't be chmod'd"
            find . -type d -exec chmod 755 {} \; 2>/dev/null || echo "âš ï¸ Some directories couldn't be chmod'd"
            
            # Set specific permissions for critical directories (if they exist)
            for dir in admin config local blocks mod theme; do
              if [ -d "$dir" ]; then
                chmod -R 755 "$dir" 2>/dev/null || echo "âš ï¸ Couldn't set permissions for $dir"
              fi
            done
            
            # Try to set ownership (may fail if not root)
            chown -R www-data:www-data . 2>/dev/null || echo "âš ï¸ Couldn't change ownership (not root user)"
            
            # Create moodledata directory if it doesn't exist
            if [ ! -d "../moodledata" ]; then
              echo "ğŸ“ Creating moodledata directory..."
              mkdir ../moodledata
              chmod 777 ../moodledata
              chown www-data:www-data ../moodledata 2>/dev/null || echo "âš ï¸ Couldn't change moodledata ownership"
            fi
            
            # Set up Moodle configuration
            echo "âš™ï¸ Setting up Moodle configuration..."
            if [ -f "config-dist.php" ]; then
              cp config-dist.php config.php
              echo "âœ… config.php created from config-dist.php"
              
              # Run initial Moodle installation/upgrade (only if config.php was created)
              echo "â¬†ï¸ Running Moodle installation/upgrade..."
              if php admin/cli/upgrade.php --non-interactive; then
                echo "âœ… Moodle installation/upgrade completed successfully"
              else
                echo "âš ï¸ Moodle installation/upgrade had issues, but continuing..."
                echo "ğŸ“ You may need to run the web-based installer manually"
              fi
            else
              echo "âš ï¸ config-dist.php not found, you'll need to create config.php manually"
            fi
            
            # Clear any existing cache (if PHP is available)
            echo "ğŸ§¹ Clearing cache..."
            if command -v php >/dev/null 2>&1; then
              php admin/cli/purge_caches.php 2>/dev/null || echo "âš ï¸ Couldn't purge caches (PHP CLI not available or no admin/cli directory)"
            else
              echo "âš ï¸ PHP not found, skipping cache purge"
            fi
            
            echo "ğŸ‰ First-time Moodle deployment completed!"
            echo "ğŸ“ Next steps:"
            echo "   1. Configure config.php with database settings"
            echo "   2. Run Moodle installation wizard"
            echo "   3. Set FIRST_TIME_DEPLOYMENT=false for future updates"

      - name: Plugin Update Deployment
        if: steps.check-secrets.outputs.deployment_type == 'plugin_update'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸ”§ Starting PLUGIN UPDATE deployment..."
            
            # Navigate to Moodle directory
            cd ${{ secrets.MOODLE_PATH }}
            
            # Create backup of existing plugin (if exists)
            if [ -d "local/test_plugin" ]; then
              echo "ğŸ“‹ Creating backup of existing plugin..."
              cp -r local/test_plugin local/test_plugin.backup.$(date +%Y%m%d_%H%M%S)
              echo "âœ… Backup created successfully"
            fi
            
            # Pull latest changes from git
            echo "ğŸ“¥ Pulling latest changes from git..."
            git pull origin master
            
            # Set proper permissions for plugin only
            echo "ğŸ” Setting proper permissions..."
            chmod -R 755 local/test_plugin
            chown -R www-data:www-data local/test_plugin
            
            # Clear Moodle cache
            echo "ğŸ§¹ Clearing Moodle cache..."
            if php admin/cli/purge_caches.php; then
              echo "âœ… Cache cleared successfully"
            else
              echo "âš ï¸ Cache clearing failed, but continuing..."
            fi
            
            # Check current plugin versions before upgrade
            echo "ğŸ“Š Pre-upgrade version check..."
            echo "ğŸ§© Current plugin versions:"
            find local/ -name "version.php" -exec echo "File: {}" \; -exec grep -E "\$plugin->version|\$plugin->component" {} \; 2>/dev/null || echo "No plugin version files found"
            
            # Run Moodle upgrade if needed
            echo "â¬†ï¸ Running Moodle upgrade..."
            if php admin/cli/upgrade.php --non-interactive; then
              echo "âœ… Moodle upgrade completed successfully"
              
              # Verify upgrade success
              echo "ğŸ” Post-upgrade verification..."
              if php admin/cli/cfg.php --component=core --name=version 2>/dev/null; then
                echo "âœ… Moodle core version updated successfully"
              else
                echo "âš ï¸ Could not verify core version update"
              fi
              
            else
              echo "âŒ Moodle upgrade failed!"
              echo "ğŸ“‹ Checking for upgrade issues..."
              
              # Check if it's a version conflict
              if [ -f "version.php" ]; then
                echo "ğŸ“Š Moodle version information:"
                grep -E "\$release|\$version" version.php || echo "Could not read version info"
              fi
              
              # Check plugin versions
              echo "ğŸ§© Plugin version information:"
              find local/ -name "version.php" -exec echo "File: {}" \; -exec grep -E "\$plugin->version|\$plugin->component" {} \; 2>/dev/null || echo "No plugin version files found"
              
              # Check for common upgrade issues
              echo "ğŸ” Common upgrade issue checks:"
              echo "- Database connection:"
              php -r "echo 'PHP version: ' . PHP_VERSION . PHP_EOL;" 2>/dev/null || echo "  PHP check failed"
              
              echo "âŒ Deployment failed due to upgrade issues"
              exit 1
            fi
            
            # Verify plugin installation
            echo "âœ… Verifying plugin installation..."
            if [ -f "local/test_plugin/version.php" ]; then
              echo "âœ… Plugin files are in place"
            else
              echo "âŒ Plugin files not found"
              exit 1
            fi
            
            echo "ğŸ‰ Plugin update deployed successfully!"

      - name: Verify First-time Deployment
        if: steps.check-secrets.outputs.deployment_type == 'first_time'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸ” Verifying first-time Moodle deployment..."
            
            # Navigate to the moodle directory
            cd ${{ secrets.SERVER_BASE_PATH }}/moodle
            
            # Check Moodle installation
            if [ -f "version.php" ]; then
              echo "âœ… Moodle installation exists"
            else
              echo "âŒ Moodle installation not found"
              echo "ğŸ“ Current directory contents:"
              ls -la
              exit 1
            fi
            
            # Check plugin directory (optional for first-time deployment)
            if [ -d "local/test_plugin" ]; then
              echo "âœ… Plugin directory exists"
            else
              echo "âš ï¸ Plugin directory not found (this is normal for first-time deployment)"
            fi
            
            # Check plugin files (optional for first-time deployment)
            if [ -f "local/test_plugin/version.php" ]; then
              echo "âœ… Plugin version file exists"
            else
              echo "âš ï¸ Plugin version file not found (this is normal for first-time deployment)"
            fi
            
            # Check moodledata directory
            if [ -d "../moodledata" ]; then
              echo "âœ… moodledata directory exists"
            else
              echo "âŒ moodledata directory not found"
              exit 1
            fi
            
            echo "ğŸ‰ First-time deployment verification completed successfully!"

      - name: Verify Plugin Update
        if: steps.check-secrets.outputs.deployment_type == 'plugin_update'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸ” Verifying plugin update deployment..."
            
            cd ${{ secrets.MOODLE_PATH }}
            
            # Check plugin directory
            if [ -d "local/test_plugin" ]; then
              echo "âœ… Plugin directory exists"
            else
              echo "âŒ Plugin directory not found"
              exit 1
            fi
            
            # Check plugin files
            if [ -f "local/test_plugin/version.php" ]; then
              echo "âœ… Plugin version file exists"
            else
              echo "âŒ Plugin version file not found"
              exit 1
            fi
            
            # Check permissions
            if [ -r "local/test_plugin/version.php" ]; then
              echo "âœ… Plugin files are readable"
            else
              echo "âŒ Plugin files are not readable"
              exit 1
            fi
            
            echo "ğŸ‰ Plugin update verification completed successfully!"

      - name: Notify First-time Deployment Success
        if: success() && steps.check-secrets.outputs.deployment_type == 'first_time'
        run: |
          echo "âœ… FIRST-TIME Moodle deployment completed successfully!"
          echo "ğŸŒ Server: ${{ secrets.SERVER_HOST }}"
          echo "ğŸ“ Moodle Path: ${{ secrets.SERVER_BASE_PATH }}/moodle"
          echo "ğŸ“… Deployment completed at $(date)"
          echo "ğŸ“ Next steps:"
          echo "   1. Configure config.php with database settings"
          echo "   2. Run Moodle installation wizard"
          echo "   3. Set FIRST_TIME_DEPLOYMENT=false for future updates"

      - name: Notify Plugin Update Success
        if: success() && steps.check-secrets.outputs.deployment_type == 'plugin_update'
        run: |
          echo "âœ… Plugin update deployed successfully!"
          echo "ğŸŒ Server: ${{ secrets.SERVER_HOST }}"
          echo "ğŸ”— Moodle URL: ${{ secrets.MOODLE_URL }}"
          echo "ğŸ“… Deployment completed at $(date)"
          echo "ğŸ¯ Plugin: local/test_plugin"

      - name: Notify Deployment Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ” Check the logs for more details."
          echo "ğŸ“… Failure occurred at $(date)"
          echo "ğŸ”„ You may need to manually deploy or check server configuration." 