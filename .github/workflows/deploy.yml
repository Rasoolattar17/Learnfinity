name: Deploy Plugin Updates

on:
  # Deploy after CI tests pass
  workflow_run:
    workflows: ["Learnfinity Plugin CI"]
    types:
      - completed
    branches: [master]
  
  # Allow manual deployment
  workflow_dispatch:
  
  # Emergency direct deployment (bypass CI)
  push:
    branches: [master]
    paths: ['.github/workflows/deploy.yml']

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only run if CI tests passed (or manual/emergency trigger)
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, '.github/workflows/deploy.yml')) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    
    # Add debugging information
    env:
      DEPLOYMENT_BRANCH: ${{ github.ref_name }}
      DEPLOYMENT_COMMIT: ${{ github.sha }}
    
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Debug Workflow Trigger
        run: |
          echo "ğŸš€ Deployment workflow triggered!"
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "ğŸ§ª Triggered by CI workflow: ${{ github.event.workflow_run.name }}"
            echo "ğŸ¯ CI workflow status: ${{ github.event.workflow_run.conclusion }}"
            echo "âœ… CI tests passed - proceeding with deployment!"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ğŸ”§ Manual deployment triggered"
          else
            echo "ğŸš¨ Emergency deployment triggered"
          fi
          
          echo "âœ… Proceeding with deployment..."

      - name: Check Required Secrets
        id: check-secrets
        run: |
          echo "ğŸ” Checking required secrets..."
          
          if [ -z "${{ secrets.MOODLE_PATH }}" ]; then
            echo "âŒ MOODLE_PATH secret is missing!"
            echo "Please configure MOODLE_PATH in GitHub Secrets"
            exit 1
          fi
          
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "âŒ SERVER_HOST secret is missing!"
            echo "Please configure SERVER_HOST in GitHub Secrets"
            exit 1
          fi
          
          if [ -z "${{ secrets.SERVER_USERNAME }}" ]; then
            echo "âŒ SERVER_USERNAME secret is missing!"
            echo "Please configure SERVER_USERNAME in GitHub Secrets"
            exit 1
          fi
          
          if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
            echo "âŒ SERVER_SSH_KEY secret is missing!"
            echo "Please configure SERVER_SSH_KEY in GitHub Secrets"
            exit 1
          fi
          
          echo "âœ… All plugin update secrets are configured"

      - name: Auto-detect Changed Plugins
        id: plugin-detection
        run: |
          echo "ğŸ” Detecting changed plugins for deployment..."
          
          # Get list of changed files
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            # For workflow_run (triggered by CI), check the triggering commit
            echo "ğŸ“‹ Checking changes in CI-triggered deployment..."
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For manual triggers, check recent commits
            echo "ğŸ“‹ Checking changes in manual deployment..."
            CHANGED_FILES=$(git diff --name-only HEAD~3 HEAD)
          else
            # For emergency pushes, check the current commit
            echo "ğŸ“‹ Checking changes in emergency deployment..."
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "ğŸ“„ Changed files:"
          echo "$CHANGED_FILES"
          
          # Get list of plugins that were changed
          PLUGINS_TO_DEPLOY=""
          
          # Check if any local plugins were changed
          if [ -d "local" ]; then
            for dir in local/*/; do
              if [ -f "${dir}version.php" ] && [ -f "${dir}lang/en/"*".php" 2>/dev/null ]; then
                PLUGIN_DIR="${dir%/}"
                PLUGIN_NAME=$(basename "$PLUGIN_DIR")
                
                # Check if any files in this plugin were changed
                if echo "$CHANGED_FILES" | grep -q "^local/$PLUGIN_NAME/"; then
                  echo "âœ… Found changed local plugin: $PLUGIN_DIR"
                  PLUGINS_TO_DEPLOY="$PLUGINS_TO_DEPLOY $PLUGIN_DIR"
                else
                  echo "â­ï¸ Skipping unchanged local plugin: $PLUGIN_DIR"
                fi
              fi
            done
          fi
          
          # Check if any mod plugins were changed
          if [ -d "mod" ]; then
            for dir in mod/*/; do
              dirname=$(basename "$dir")
              # Skip built-in Moodle modules, focus on custom ones
              if [[ ! "$dirname" =~ ^(assign|book|chat|choice|data|feedback|forum|glossary|h5pactivity|imscp|label|lesson|lti|page|quiz|resource|scorm|survey|url|wiki|workshop)$ ]] && [ -f "${dir}version.php" ]; then
                PLUGIN_DIR="${dir%/}"
                PLUGIN_NAME=$(basename "$PLUGIN_DIR")
                
                # Check if any files in this plugin were changed
                if echo "$CHANGED_FILES" | grep -q "^mod/$PLUGIN_NAME/"; then
                  echo "âœ… Found changed mod plugin: $PLUGIN_DIR"
                  PLUGINS_TO_DEPLOY="$PLUGINS_TO_DEPLOY $PLUGIN_DIR"
                else
                  echo "â­ï¸ Skipping unchanged mod plugin: $PLUGIN_DIR"
                fi
              fi
            done
          fi
          
          # Check if any block plugins were changed
          if [ -d "blocks" ]; then
            for dir in blocks/*/; do
              dirname=$(basename "$dir")
              # Skip built-in Moodle blocks, focus on custom ones
              if [[ ! "$dirname" =~ ^(accessreview|activity_modules|activity_results|admin_bookmarks|badges|blog_menu|blog_recent|blog_tags|calendar_month|calendar_upcoming|comments|completionstatus|course_list|course_summary|feedback|globalsearch|glossary_random|html|login|lp|mentees|mnet_hosts|myoverview|myprofile|navigation|news_items|online_users|private_files|recent_activity|recentlyaccessedcourses|recentlyaccesseditems|rss_client|search_forums|section_links|selfcompletion|settings|site_main_menu|social_activities|starredcourses|tag_flickr|tag_youtube|tags|timeline)$ ]] && [ -f "${dir}version.php" ]; then
                PLUGIN_DIR="${dir%/}"
                PLUGIN_NAME=$(basename "$PLUGIN_DIR")
                
                # Check if any files in this plugin were changed
                if echo "$CHANGED_FILES" | grep -q "^blocks/$PLUGIN_NAME/"; then
                  echo "âœ… Found changed block plugin: $PLUGIN_DIR"
                  PLUGINS_TO_DEPLOY="$PLUGINS_TO_DEPLOY $PLUGIN_DIR"
                else
                  echo "â­ï¸ Skipping unchanged block plugin: $PLUGIN_DIR"
                fi
              fi
            done
          fi
          
          # Fallback if no plugins detected or if it's a manual trigger
          if [ -z "$PLUGINS_TO_DEPLOY" ]; then
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo "âš ï¸ No changed plugins detected in manual trigger, deploying all plugins..."
              # For manual triggers, deploy all plugins
              PLUGINS_TO_DEPLOY=""
              if [ -d "local" ]; then
                for dir in local/*/; do
                  if [ -f "${dir}version.php" ] && [ -f "${dir}lang/en/"*".php" 2>/dev/null ]; then
                    PLUGIN_DIR="${dir%/}"
                    echo "âœ… Found local plugin: $PLUGIN_DIR"
                    PLUGINS_TO_DEPLOY="$PLUGINS_TO_DEPLOY $PLUGIN_DIR"
                  fi
                done
              fi
              if [ -d "mod" ]; then
                for dir in mod/*/; do
                  dirname=$(basename "$dir")
                  if [[ ! "$dirname" =~ ^(assign|book|chat|choice|data|feedback|forum|glossary|h5pactivity|imscp|label|lesson|lti|page|quiz|resource|scorm|survey|url|wiki|workshop)$ ]] && [ -f "${dir}version.php" ]; then
                    PLUGIN_DIR="${dir%/}"
                    echo "âœ… Found mod plugin: $PLUGIN_DIR"
                    PLUGINS_TO_DEPLOY="$PLUGINS_TO_DEPLOY $PLUGIN_DIR"
                  fi
                done
              fi
              if [ -d "blocks" ]; then
                for dir in blocks/*/; do
                  dirname=$(basename "$dir")
                  if [[ ! "$dirname" =~ ^(accessreview|activity_modules|activity_results|admin_bookmarks|badges|blog_menu|blog_recent|blog_tags|calendar_month|calendar_upcoming|comments|completionstatus|course_list|course_summary|feedback|globalsearch|glossary_random|html|login|lp|mentees|mnet_hosts|myoverview|myprofile|navigation|news_items|online_users|private_files|recent_activity|recentlyaccessedcourses|recentlyaccesseditems|rss_client|search_forums|section_links|selfcompletion|settings|site_main_menu|social_activities|starredcourses|tag_flickr|tag_youtube|tags|timeline)$ ]] && [ -f "${dir}version.php" ]; then
                    PLUGIN_DIR="${dir%/}"
                    echo "âœ… Found block plugin: $PLUGIN_DIR"
                    PLUGINS_TO_DEPLOY="$PLUGINS_TO_DEPLOY $PLUGIN_DIR"
                  fi
                done
              fi
            else
              echo "âš ï¸ No changed plugins detected, falling back to local/test_plugin"
              PLUGINS_TO_DEPLOY="local/test_plugin"
            fi
          fi
          
          # Store plugins for deployment
          if [ -n "$PLUGINS_TO_DEPLOY" ]; then
            echo "ğŸ“‹ Changed plugins to deploy: $PLUGINS_TO_DEPLOY"
            echo "PLUGINS_TO_DEPLOY=$PLUGINS_TO_DEPLOY" >> $GITHUB_ENV
            echo "plugins_to_deploy=$PLUGINS_TO_DEPLOY" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No plugins detected, falling back to local/test_plugin"
            echo "PLUGINS_TO_DEPLOY=local/test_plugin" >> $GITHUB_ENV
            echo "plugins_to_deploy=local/test_plugin" >> $GITHUB_OUTPUT
          fi

      - name: Plugin Update Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # Get the list of plugins to deploy
            PLUGINS_TO_DEPLOY="${{ env.PLUGINS_TO_DEPLOY }}"
            
            echo "ğŸ”§ Starting MULTI-PLUGIN UPDATE deployment..."
            echo "ğŸ“‹ Plugins to deploy: $PLUGINS_TO_DEPLOY"
            
            # Navigate to Moodle directory
            cd ${{ secrets.MOODLE_PATH }}
            echo "ğŸ“ Current directory: $(pwd)"
            
            # Check if this is a git repository
            if [ ! -d ".git" ]; then
              echo "âŒ Not a git repository. Cannot pull latest changes."
              echo "ğŸ“ Current directory contents:"
              ls -la
              exit 1
            fi
            
            # Pull latest changes from git
            echo "ğŸ“¥ Pulling latest changes from git..."
            git pull origin master
            
            # Deploy each plugin
            for plugin_path in $PLUGINS_TO_DEPLOY; do
              echo "ğŸ¯ Deploying plugin: $plugin_path"
              
              # Create backup of existing plugin (if exists)
              if [ -d "$plugin_path" ]; then
                echo "ğŸ“‹ Creating backup of existing plugin..."
                cp -r $plugin_path ${plugin_path}.backup.$(date +%Y%m%d_%H%M%S)
                echo "âœ… Backup created successfully for $plugin_path"
              fi
              
              # Set proper permissions for plugin
              echo "ğŸ” Setting proper permissions for $plugin_path..."
              if [ -d "$plugin_path" ]; then
                chmod -R 755 $plugin_path
                chown -R www-data:www-data $plugin_path
                echo "âœ… Permissions set for $plugin_path"
              else
                echo "âŒ Plugin directory $plugin_path not found!"
                echo "ğŸ“ Available local plugins:"
                ls -la local/ 2>/dev/null || echo "No local plugins found"
                echo "âš ï¸ Continuing with other plugins..."
                continue
              fi
              
              # Verify plugin installation
              echo "âœ… Verifying plugin installation for $plugin_path..."
              if [ -f "$plugin_path/version.php" ]; then
                echo "âœ… Plugin files are in place for $plugin_path"
                echo "ğŸ“Š Plugin version info for $plugin_path:"
                grep -E "\$plugin->version|\$plugin->component" $plugin_path/version.php 2>/dev/null || echo "Could not read plugin version"
              else
                echo "âŒ Plugin files not found at $plugin_path"
                echo "ğŸ“ Available files in plugin directory:"
                ls -la $plugin_path 2>/dev/null || echo "Plugin directory not accessible"
                echo "âš ï¸ Continuing with other plugins..."
                continue
              fi
              
              echo "âœ… Successfully deployed plugin: $plugin_path"
            done
            
            # Clear Moodle cache after all plugins are deployed
            echo "ğŸ§¹ Clearing Moodle cache..."
            if [ -f "admin/cli/purge_caches.php" ]; then
              if php admin/cli/purge_caches.php; then
                echo "âœ… Cache cleared successfully"
              else
                echo "âš ï¸ Cache clearing failed, but continuing..."
              fi
            else
              echo "âš ï¸ Cache clearing script not found, but continuing..."
            fi
            
            # Check current plugin versions before upgrade
            echo "ğŸ“Š Pre-upgrade version check..."
            echo "ğŸ§© Current plugin versions:"
            find local/ -name "version.php" -exec echo "File: {}" \; -exec grep -E "\$plugin->version|\$plugin->component" {} \; 2>/dev/null || echo "No plugin version files found"
            
            # Run Moodle upgrade if needed
            echo "â¬†ï¸ Running Moodle upgrade..."
            if [ -f "admin/cli/upgrade.php" ]; then
              if php admin/cli/upgrade.php --non-interactive; then
                echo "âœ… Moodle upgrade completed successfully"
                
                # Verify upgrade success
                echo "ğŸ” Post-upgrade verification..."
                if php admin/cli/cfg.php --component=core --name=version 2>/dev/null; then
                  echo "âœ… Moodle core version updated successfully"
                else
                  echo "âš ï¸ Could not verify core version update"
                fi
                
              else
                echo "âŒ Moodle upgrade failed!"
                echo "ğŸ“‹ Checking for upgrade issues..."
                
                # Check if it's a version conflict
                if [ -f "version.php" ]; then
                  echo "ğŸ“Š Moodle version information:"
                  grep -E "\$release|\$version" version.php || echo "Could not read version info"
                fi
                
                # Check plugin versions
                echo "ğŸ§© Plugin version information:"
                find local/ -name "version.php" -exec echo "File: {}" \; -exec grep -E "\$plugin->version|\$plugin->component" {} \; 2>/dev/null || echo "No plugin version files found"
                
                # Check for common upgrade issues
                echo "ğŸ” Common upgrade issue checks:"
                echo "- Database connection:"
                php -r "echo 'PHP version: ' . PHP_VERSION . PHP_EOL;" 2>/dev/null || echo "  PHP check failed"
                
                echo "âŒ Deployment failed due to upgrade issues"
                exit 1
              fi
            else
              echo "âš ï¸ Upgrade script not found, skipping upgrade..."
            fi
            
            echo "ğŸ‰ Multi-plugin deployment completed successfully!"

      - name: Verify Plugin Updates
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸ” Verifying multi-plugin deployment..."
            
            cd ${{ secrets.MOODLE_PATH }}
            
            # Get the list of plugins that were deployed
            PLUGINS_TO_VERIFY="${{ steps.plugin-detection.outputs.plugins_to_deploy }}"
            
            echo "ğŸ“‹ Verifying plugins: $PLUGINS_TO_VERIFY"
            
            # Verify each plugin
            for plugin_path in $PLUGINS_TO_VERIFY; do
              echo "ğŸ” Verifying plugin: $plugin_path"
              
              # Check plugin directory
              if [ -d "$plugin_path" ]; then
                echo "âœ… Plugin directory exists: $plugin_path"
              else
                echo "âŒ Plugin directory not found: $plugin_path"
                exit 1
              fi
              
              # Check plugin files
              if [ -f "$plugin_path/version.php" ]; then
                echo "âœ… Plugin version file exists: $plugin_path"
              else
                echo "âŒ Plugin version file not found: $plugin_path"
                exit 1
              fi
              
              # Check permissions
              if [ -r "$plugin_path/version.php" ]; then
                echo "âœ… Plugin files are readable: $plugin_path"
              else
                echo "âŒ Plugin files are not readable: $plugin_path"
                exit 1
              fi
            done
            
            echo "ğŸ‰ Multi-plugin verification completed successfully!"

      - name: Notify Plugin Update Success
        if: success()
        run: |
          echo "âœ… Multi-plugin update deployed successfully!"
          echo "ğŸŒ Server: ${{ secrets.SERVER_HOST }}"
          echo "ğŸ”— Moodle URL: ${{ secrets.MOODLE_URL }}"
          echo "ğŸ“… Deployment completed at $(date)"
          echo "ğŸ¯ Plugins deployed: ${{ steps.plugin-detection.outputs.plugins_to_deploy }}"

      - name: Notify Deployment Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ” Check the logs for more details."
          echo "ğŸ“… Failure occurred at $(date)"
          echo "ğŸ”„ You may need to manually deploy or check server configuration." 